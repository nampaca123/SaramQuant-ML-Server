# 테스트 주요 이슈 및 해결 (2026-02-16)

## 1. numpy 2.x 스칼라 타입 SQL 주입 오류

### 원인

numpy 2.x에서 `np.float64` 스칼라의 `repr()`이 `np.float64(1.234)` 형태로 변경되었다. `psycopg2.extras.execute_values`가 이 값을 문자열 그대로 SQL에 삽입하면서, PostgreSQL이 `np`를 스키마 이름으로 해석하여 `InvalidSchemaName: schema "np" does not exist` 오류 발생.

### 영향 범위

`indicator_service.py`의 `_compute_risk`에서 `beta()`, `alpha()`, `sharpe_ratio()` 반환값이 `np.float64`인 모든 곳. 이들 값이 `execute_values`를 통해 `stock_indicators` 테이블에 삽입될 때 발생.

### 수정

`_compute_risk` 내부에서 numpy 반환값을 `float()`로 명시적 변환:

```python
beta_val = round(float(beta(stock_ret, benchmark_ret)), 4)
alpha_val = round(float(alpha(stock_ret, benchmark_ret, rf_rate, beta_val)), 4)
sharpe_val = round(float(sharpe_ratio(stock_ret, rf_rate)), 4)
```

### 교훈

numpy 2.x를 사용할 때 DB 삽입 전 반드시 Python 네이티브 타입으로 변환 필요. `_safe_last()`에서는 이미 `float()`로 감싸고 있었으나, risk 계산부에서 누락.

---

## 2. 일봉 0건 종목 비활성 처리

### 원인

KR 39종목, US 4종목이 상장 목록에는 있으나 일봉 데이터가 단 한 건도 없음. 거래정지(카프로, 위니아에이드, DKME 등), SPAC 유닛, 초신규 IPO 등이 해당.

### 문제점

- 퀀트 분석(지표/펀더멘털 계산)이 물리적으로 불가능
- 프론트엔드에 노출 시 빈 데이터만 보임 → UX 저하

### 해결

파이프라인 완료 후 `is_active = false`로 비활성 처리하는 로직 추가:

- `StockRepository.deactivate_no_price_stocks(market)` — 일봉 없는 활성 종목을 비활성화
- `PipelineOrchestrator`에서 일봉 수집 → 비활성 처리 → 지표 계산 순서로 호출
- `upsert_batch`의 `ON CONFLICT`에 `is_active = true` 추가 → 다음 MST 수집 시 상장 확인되면 자동 복원

---

## 3. 펀더멘털 NULL 상태 구분 (data_coverage)

### 배경

`stock_fundamentals` 테이블에서 PER/EPS 등이 NULL인 경우, 원인이 다양함:
- 적자 기업 (EPS < 0 → PER 산출 불가)
- 분기 데이터 부족 (TTM 계산 불가)
- 재무제표 자체 미등록

NULL만으로는 원인을 구분할 수 없어, 프론트에서 적절한 메시지를 보여줄 수 없었음.

### 해결

`data_coverage_type` enum 도입:

| 값 | 의미 | PER 상태 |
|---|---|---|
| `FULL` | 모든 펀더멘털 산출 완료 | 양수 |
| `LOSS` | 적자 기업 (EPS < 0) | 음수 |
| `PARTIAL` | 대차대조표만 있음 | NULL |
| `INSUFFICIENT` | 분기 데이터 4개 미만 | NULL |
| `NO_FS` | 재무제표 자체 미등록 | NULL |

판정 흐름: TTM 가능 → EPS 부호로 FULL/LOSS 분기 → 불가 시 대차대조표 유무로 PARTIAL/INSUFFICIENT 분기. 재무제표 자체가 없는 종목은 `fundamental_compute.py`에서 `NO_FS` row를 별도 생성.

### 변경 파일

| 파일 | 변경 내용 |
|---|---|
| `db_table.sql` | enum 타입 생성, `stock_fundamentals`에 컬럼 추가 |
| `app/schema/enums/data_coverage.py` | Python enum 생성 |
| `app/services/fundamental_service.py` | `compute()` 반환 tuple에 판정 결과 추가 |
| `app/pipeline/fundamental_compute.py` | NO_FS 종목 row 생성 |
| `app/db/repositories/fundamental.py` | COLUMNS에 `data_coverage` 추가 |
