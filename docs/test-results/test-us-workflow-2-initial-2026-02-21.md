# US 워크플로우 초기실행 테스트 결과 — 리스크 뱃지 포함 (2026-02-21)

## 목적

테이블 초기화 후 리스크 뱃지 시스템이 포함된 US 초기실행 파이프라인을 검증한다.
기존 지표가 동일 영업일 기준 이전 테스트와 일치하는지 확인하고,
신규 추가된 **Risk Badge 시스템**의 계산 정합성을 검증한다.

## 실행 환경

| 항목 | 값 |
|---|---|
| OS | Windows 10 (10.0.26200) |
| Python | 3.14.3 |
| DB | Supabase PostgreSQL (Transaction Pooler) |
| 실행 방식 | `python -m app.pipeline us-initial` |
| 사전 작업 | KR initial 완료 후 연속 실행 |

## 단계별 소요시간

### `python -m app.pipeline us-initial` — 총 15분 53초

| 단계 | 시작 | 종료 | 소요 | 비고 |
|---|---|---|---|---|
| 종목 목록 수집 | 17:55:34 | 17:55:36 | **2초** | NYSE 2,041 + NASDAQ 3,863 = 5,904종목 |
| 섹터 수집 | 17:55:36 | 18:03:03 | **7분 27초** | Screener 97 + Finnhub 57 = 154건 (주1) |
| 일봉 수집 | 18:03:03 | 18:06:17 | **3분 14초** | 119배치, 5,896 symbols → 4,182 upsert rows |
| 벤치마크 수집 | 18:06:17 | 18:06:19 | **2초** | SP500 42 + NASDAQ 42 = 84건 |
| 무위험이자율 수집 | 18:06:19 | 18:06:26 | **7초** | 91D/1Y/3Y/10Y 각 35건 = 140건 |
| 재무제표 수집 (Remote) | 18:06:26 | 18:10:10 | **3분 44초** | 5,904종목, 45,886 stmts |
| 비활성화 + Safety check | 18:10:10 | 18:10:14 | **4초** | 4,368/5,904 active (74.0%) |
| 펀더멘털 계산 | 18:10:14 | 18:10:39 | **25초** | 4,368건 |
| 팩터 모델 | 18:10:39 | 18:10:42 | **3초** | NYSE 24 + NASDAQ 24 = 48 팩터 수익률 |
| 지표 계산 | 18:10:42 | 18:11:17 | **35초** | NYSE 1,580 + NASDAQ 2,747 = 4,327종목 |
| 섹터 집계 | 18:11:17 | 18:11:17 | **< 1초** | 44건 |
| **리스크 뱃지 계산** | **18:11:17** | **18:11:23** | **6초** | **NYSE 1,580 + NASDAQ 2,747 = 4,327건** |
| 무결성 검사 | 18:11:25 | 18:11:27 | **2초** | PASS |

**(주1)** Finnhub fallback 407종목 API 호출에 7분 소요 (rate limit 1요청/1.1초).

## 비활성화 현황

| 마켓 | 활성 | 비활성 | 합계 | 활성률 |
|---|---|---|---|---|
| US_NYSE | 1,587 | 454 | 2,041 | 77.8% |
| US_NASDAQ | 2,781 | 1,082 | 3,863 | 72.0% |
| **합계** | **4,368** | **1,536** | **5,904** | **74.0%** |

이전 동일 영업일 테스트(US initial 2/21)와 동일.

## 기존 지표 — 이전 테스트 대비 비교

동일 영업일(2/21)이므로 계산 결과가 일치해야 한다.

| 항목 | 이전 initial (2/21) | 이번 initial-2 (2/21) | 일치 |
|---|---|---|---|
| 종목 수 | 5,904 | 5,904 | ✅ |
| 활성 종목 | 4,368 | 4,368 | ✅ |
| 펀더멘털 | 4,368 | 4,368 | ✅ |
| 지표 | 4,327 | 4,327 | ✅ |
| 팩터 노출도 | 4,362 | 4,363 | ≈ (주2) |
| 재무제표 | 45,886 | 45,886 | ✅ |
| negative_equity | 468 | 468 | ✅ |
| clamped | 203 | 203 | ✅ |
| shares_sanitized | 7 | 7 | ✅ |
| 무결성 (no_fs) | 3 | 3 | ✅ |

**(주2)** factor_exposures 1건 차이(4,362→4,363): 팩터 모델 회귀 시 결측 패턴에 따른 경계 종목 1건의 미세 변동. 실질적 차이 없음.

## 리스크 뱃지 검증 (신규)

### 건수 정합성

| 항목 | 파이프라인 로그 | DB 실제 | 일치 |
|---|---|---|---|
| US_NYSE | 1,580 | 1,580 | ✅ |
| US_NASDAQ | 2,747 | 2,747 | ✅ |
| **합계** | **4,327** | **4,327** | ✅ |

뱃지 날짜: 전체 4,327건 모두 `2026-02-21`. 뱃지 건수 = 지표(stock_indicators) 건수와 정확히 일치.

### 차원 완전성

| 검증 항목 | 결과 |
|---|---|
| 5개 차원 보유 | 4,327/4,327 (100%) |
| 5개 미만 | 0 |
| data_available=false 포함 | 574건 |

#### data_available=false 내역

| 마켓 | 차원 | 건수 | 원인 |
|---|---|---|---|
| US_NYSE | company_health | 45 | 펀더멘털 데이터 부족 (은행/REIT 등) |
| US_NYSE | valuation | 146 | PER/PBR 극단 이상치 또는 데이터 부족 |
| US_NYSE | price_heat | 1 | BB 평탄화 + RSI 부족 |
| US_NYSE | trend | 1 | ADX 계산 불가 |
| US_NASDAQ | company_health | 201 | 펀더멘털 데이터 부족 (바이오텍 등) |
| US_NASDAQ | valuation | 372 | PER/PBR 극단 이상치 또는 데이터 부족 |

US가 KR(2건) 대비 `data_available=false`가 많은 이유:
- 미국 시장은 자본잠식(negative equity) 468건, 영업이익률 미보유(은행/보험/REIT), NASDAQ 소형 바이오텍 적자 기업 등 구조적으로 펀더멘털 데이터 결측이 많음
- 설계 문서의 "전체 펀더멘털 NULL → data_available=False" 방어 로직이 정상 동작

### 종합 뱃지(Composite) 분포

| 마켓 | STABLE | CAUTION | WARNING |
|---|---|---|---|
| US_NYSE | 355 (22.5%) | 701 (44.4%) | 524 (33.2%) |
| US_NASDAQ | 438 (15.9%) | 1,074 (39.1%) | 1,235 (45.0%) |
| **합계** | **793 (18.3%)** | **1,775 (41.0%)** | **1,759 (40.6%)** |

NASDAQ WARNING 비율(45.0%)이 NYSE(33.2%)보다 높음 — NASDAQ 소형주(바이오텍, 초기 테크)의 적자/고평가 비율이 구조적으로 높기 때문.

### KR vs US 종합 비교

| 마켓 | STABLE | CAUTION | WARNING |
|---|---|---|---|
| KR (합계) | 21.0% | 40.2% | 38.8% |
| US (합계) | 18.3% | 41.0% | 40.6% |

US가 KR보다 WARNING 비율이 약간 높음. NASDAQ 소형주의 구조적 리스크 반영.

### 차원별 티어 분포

| 차원 | 티어 | NYSE | NASDAQ |
|---|---|---|---|
| price_heat | STABLE | 1,441 | 2,314 |
| | CAUTION | 117 | 321 |
| | WARNING | 22 | 112 |
| volatility | STABLE | 1,245 | 2,103 |
| | CAUTION | 272 | 450 |
| | WARNING | 63 | 194 |
| trend | STABLE | 1,392 | 2,261 |
| | CAUTION | 173 | 431 |
| | WARNING | 15 | 55 |
| company_health | STABLE | 802 | 1,089 |
| | CAUTION | 536 | 1,075 |
| | WARNING | 242 | 583 |
| valuation | STABLE | 714 | 1,022 |
| | CAUTION | 583 | 1,026 |
| | WARNING | 283 | 699 |

- **volatility**: US WARNING 257건(5.9%) vs KR 4건(0.2%) — 미국 시장이 변동성 측면에서 KR보다 더 다양한 스펙트럼을 보임. 베타 이상치 종목 다수 존재.
- **trend**: US WARNING 70건(1.6%) vs KR 1건(0.04%) — 미국 시장에서 강한 추세(상승/하락) 종목이 더 많음.
- **company_health/valuation**: US WARNING 비율 약 19~23%. KR(16~22%)과 유사하나 NASDAQ이 상향 견인.

### 종합 뱃지 규칙 검증

| 검증 항목 | 결과 | 판정 |
|---|---|---|
| Critical WARNING → summary WARNING | 1,570건 전부 정확 | ✅ PASS |
| Critical WARNING → NOT WARNING (버그) | 0건 | ✅ PASS |
| Critical WARNING 없는 종목 | 2,757건 | — |

### 차원별 점수 분포

| 마켓 | 전체 평균 | 최솟값 | 최댓값 |
|---|---|---|---|
| US_NYSE | 30.8 | 0.0 | 100.0 |
| US_NASDAQ | 34.3 | 0.0 | 100.0 |

NASDAQ 평균(34.3)이 NYSE(30.8)보다 높음 — 소형주 리스크가 점수에 반영.

## 데이터 수집 현황 (DB — KR + US 합산)

| 테이블 | KR | US | 합계 |
|---|---|---|---|
| stocks | 2,607 | 5,904 | 8,511 |
| daily_prices | 658,257 | 1,514,182 | 2,172,439 |
| financial_statements | 17,164 | 45,886 | 63,050 |
| stock_fundamentals | 2,459 | 4,368 | 6,827 |
| stock_indicators | 2,428 | 4,327 | 6,755 |
| factor_exposures | 2,459 | 4,363 | 6,822 |
| factor_returns | 56 | 48 | 104 |
| sector_aggregates | 42 | 44 | 86 |
| benchmark_daily_prices | — | — | 6,096 |
| **risk_badges** | **2,428** | **4,327** | **6,755** |

risk_badges 합계(6,755) = stock_indicators 합계(6,755) — 정확히 일치.

## 펀더멘털 계산 품질 (US)

| 항목 | 건수 | 비고 |
|---|---|---|
| shares_sanitized | 7 | 이전과 동일 |
| clamped | 203 | 이전과 동일 |
| negative_equity | 468 | 이전과 동일 (10.7%) |

이전 테스트(2/21)와 완전 일치. 동일 영업일 동일 데이터 확인.

## 무결성 검사

| 마켓 | active | quant_eligible | no_fs | no_price |
|---|---|---|---|---|
| KR_KOSPI | 790 | 790 | 0 | 0 |
| KR_KOSDAQ | 1,669 | 1,669 | 0 | 0 |
| US_NYSE | 1,587 | 1,587 | 1 | 0 |
| US_NASDAQ | 2,781 | 2,781 | 2 | 0 |

## 종합 검증 결과

| 검증 항목 | 결과 | 판정 |
|---|---|---|
| 기존 지표 이전 테스트 대비 일치 | KR/US 모두 동일 (팩터 1건 미세 차이) | PASS |
| 리스크 뱃지 건수 = 지표 건수 | KR 2,428 / US 4,327 = 6,755 일치 | PASS |
| 5개 차원 완전성 | KR 100% / US 100% | PASS |
| 종합 뱃지 Critical 규칙 | KR 916건 + US 1,570건 전부 정확, 버그 0 | PASS |
| data_available=false 방어 | KR 2건 / US 574건 — 구조적 원인 정상 | PASS |
| 티어 분포 합리성 | NASDAQ > NYSE > KOSDAQ > KOSPI WARNING 비율 | PASS |
| Safety check | KR 94.3% / US 74.0% | PASS |
| 무결성 검사 | 통과 | PASS |

## 발견 사항

| 항목 | 심각도 | 내용 |
|---|---|---|
| 리스크 뱃지 계산 시간 | INFO | KR < 1초, US 6초. 전체 파이프라인(27분) 대비 무시할 수준 |
| US data_available=false 574건 | INFO | 전체 4,327건 중 13.3%. 자본잠식 468건 + 은행/REIT/바이오텍의 구조적 데이터 부족. 설계 문서 예상 범위 내 |
| KR vs US WARNING 비율 차이 | INFO | US(40.6%) > KR(38.8%). NASDAQ 소형주의 구조적 리스크 반영 |
| 전체 뱃지 건수 = 지표 건수 일치 | INFO | risk_badges와 stock_indicators가 정확히 동수. 뱃지 계산이 지표 계산 결과를 빠짐없이 소비 |
| factor_exposures 1건 차이 | LOW | 이전 4,362 → 이번 4,363. 팩터 모델 회귀 경계 종목의 미세 변동. 실질 영향 없음 |
