# KR 워크플로우 초기실행 테스트 결과 (2026-02-17)

## 실행 환경

| 항목 | 값 |
|---|---|
| OS | Windows 10 (10.0.26200) |
| Python | 3.14.3 |
| DB | Supabase PostgreSQL (Transaction Pooler) |
| 실행 방식 | `python -m app.pipeline kr-initial` (통합 커맨드) |

## 변경 사항 (2/16 대비)

| 변경 | 내용 |
|---|---|
| 수집 기간 확장 | `timedelta(days=365)` → `INITIAL_LOOKBACK_DAYS = 400` (중앙 상수) |
| 팩터 모델 추가 | `factor_compute` 단계 신규 (exposure, regression, covariance) |
| 파이프라인 통합 | `kr` + `kr-fs` 분리 실행 → `kr-initial` 단일 커맨드 |
| 비활성화 강화 | no-price / no-sector / no-FS 3단계 progressive deactivation |

## 단계별 소요시간

### `python -m app.pipeline kr-initial` — 총 11분 44초

| 단계 | 시작 | 종료 | 소요 | 비고 |
|---|---|---|---|---|
| 종목 목록 수집 | 16:18:38 | 16:18:39 | **1초** | KOSPI 896 + KOSDAQ 1,711 = 2,607종목 |
| 섹터 수집 | 16:18:39 | 16:19:20 | **41초** | 89건 업데이트 (pykrx) |
| 일봉 수집 (KOSPI) | 16:19:20 | 16:22:51 | **3분 31초** | 400역일 → 265 거래일 |
| 일봉 수집 (KOSDAQ) | 16:22:51 | 16:27:18 | **4분 27초** | 400역일 → 265 거래일 |
| 벤치마크 수집 | 16:27:18 | 16:27:27 | **9초** | KOSPI + KOSDAQ 지수 |
| 무위험이자율 수집 | 16:27:27 | 16:29:20 | **1분 53초** | 91D, 3Y, 10Y (ECOS API) |
| 재무제표 수집 | 16:29:20 | 16:29:49 | **29초** | DART corp_code 동기화 + 208 API 호출, 17,154건 |
| 비활성화 | 16:29:49 | 16:29:51 | **2초** | no-price 37 / no-sector 17 / no-FS 94 → 2,459 활성 |
| 펀더멘털 계산 | 16:29:51 | 16:30:00 | **9초** | 2,459종목 |
| 팩터 모델 | 16:30:00 | 16:30:02 | **2초** | KOSPI 28팩터 + KOSDAQ 28팩터 |
| 지표 계산 | 16:30:02 | 16:30:22 | **20초** | 2,427종목 |
| 섹터 집계 | 16:30:22 | 16:30:22 | **< 1초** | 42건 |
| 무결성 검사 | 16:30:22 | 16:30:22 | **< 1초** | PASS |

## 데이터 수집 현황

| 테이블 | 건수 | 2/16 대비 |
|---|---|---|
| stocks | 2,607 | 동일 |
| daily_prices | 663,082 | +49,493 (수집 기간 35일 확장) |
| stock_indicators | 2,427 | -105 (비활성화 강화로 분모 변경) |
| financial_statements | 17,154 | 동일 |
| stock_fundamentals | 2,459 | -15 |
| factor_exposures | 2,459 | **신규** |
| factor_returns | 56 | **신규** (KOSPI 28 + KOSDAQ 28) |
| sector_aggregates | 42 | **신규** |
| benchmark_daily_prices | 3,008 | 동일 |
| risk_free_rates | 19,120 | 동일 |

## 데이터 품질 검증

### 필터링

| 항목 | 결과 | 판정 |
|---|---|---|
| 스팩 종목 포함 여부 | 0건 | PASS |
| 이상 가격 (close <= 0 또는 high < low) | 0건 | PASS |

### 커버리지

| 마켓 | 활성 종목 | 일봉 보유 | 지표 계산 | 펀더멘털 | 팩터 노출도 |
|---|---|---|---|---|---|
| KR_KOSPI | 790 | 790 (100%) | 782 (98.9%) | 790 (100%) | 790 (100%) |
| KR_KOSDAQ | 1,669 | 1,669 (100%) | 1,645 (98.6%) | 1,669 (100%) | 1,669 (100%) |

- 지표 미계산 32종목: 일봉 60일 미만 (신규 상장/거래재개 종목)
- 비활성화 적용으로 활성 종목은 100% 일봉·펀더멘털·팩터 보유

### 팩터 노출도 항목별 채움률 (2,459건 기준)

| 항목 | 건수 | 비율 |
|---|---|---|
| size | 2,459 | 100.0% |
| value | 2,450 | 99.6% |
| momentum | 2,300 | 93.5% |
| volatility | 2,446 | 99.5% |
| quality | 2,209 | 89.9% |
| leverage | 2,459 | 100.0% |

- momentum 미산출 159건: 252거래일 미만 종목 (DB 확인: 252일+ 보유 종목 2,300개와 정확히 일치)
- quality 미산출 250건: ROE/영업이익률 미보유 기업

### 팩터 수익률

| 마켓 | 팩터 수 | 구성 |
|---|---|---|
| KR_KOSPI | 28 | market(1) + style(6) + industry(21) |
| KR_KOSDAQ | 28 | market(1) + style(6) + industry(21) |

- 6개 스타일 팩터 전부 포함 (momentum 포함 — 수집 기간 확장 효과 확인)

### 펀더멘털 항목별 채움률 (2,459건 기준)

| 항목 | 건수 | 비율 |
|---|---|---|
| PER | 2,210 | 89.9% |
| PBR | 2,450 | 99.6% |
| EPS | 2,210 | 89.9% |
| ROE | 2,210 | 89.9% |
| 부채비율 | 2,459 | 100.0% |
| 영업이익률 | 2,209 | 89.8% |

- PER/EPS 미산출 249건: 적자 기업(EPS <= 0)으로 PER 산출 불가

### 일봉 가격일 분포

| 구간 | 종목 수 | 비율 |
|---|---|---|
| 252일 이상 | 2,300 | 93.5% |
| 60~251일 | 127 | 5.2% |
| 60일 미만 | 32 | 1.3% |

- 최대 265일 / 최소 5일 / 평균 258일

### 기간

| 데이터 | 시작일 | 종료일 | 거래일 수 |
|---|---|---|---|
| 일봉 | 2025-01-14 | 2026-02-13 | 265일 |
| 벤치마크 (KOSPI/KOSDAQ) | 2020-01-02 | 2026-02-13 | 1,504일 |
| 무위험이자율 | 2000-01-04 | 2026-02-13 | 19,120건 |

## 발견 사항

### 수정한 버그

1. **팩터 모델 shape mismatch** — `factor_model_service.py`에서 `n_styles = len(STYLE_FACTORS)`를 하드코딩(6)으로 사용. 데이터 부족으로 style 팩터 컬럼이 제거될 경우 constraint vector 크기 불일치 발생. `n_styles`를 실제 존재 컬럼 수로 동적 계산하도록 수정, excess-return 필터 후 zero-variance 컬럼 재검사 추가.

2. **수집 기간 부족** — `timedelta(days=365)` = 245 거래일로 momentum 계산(252일 필요)에 미달. `INITIAL_LOOKBACK_DAYS = 400`으로 확장하여 265 거래일 확보. 상수를 `market_groups.py`에 중앙 관리.

### 기존 미해결 (2/16 이월)

- **로그 표시 오차**: `execute_values`의 `rowcount` 문제로 indicator 삽입 건수가 실제와 다르게 표시됨 (로그: 27건, 실제: 2,427건)
- **pykrx FutureWarning**: `df.replace("", 0)` downcasting 관련. 라이브러리 내부 문제, 기능 영향 없음

### 신규 발견

- **trading days 로그 부정확**: `kr_daily_price.py`의 `trading_days` 카운터가 pykrx가 데이터를 반환한 날(비거래일 포함)을 세므로 실제 거래일(265)보다 높게 표시됨(400). `_upsert_day` 반환값(> 0)으로 판별하도록 개선 필요.
