# KR 워크플로우 초기실행 테스트 결과 — 리스크 뱃지 포함 (2026-02-21)

## 목적

테이블 초기화 후 리스크 뱃지 시스템이 포함된 KR 초기실행 파이프라인을 검증한다.
기존 지표(펀더멘털, 팩터, 인디케이터)가 동일 영업일 기준 이전 테스트와 일치하는지 확인하고,
신규 추가된 **Risk Badge 시스템**의 계산 정합성을 검증한다.

## 실행 환경

| 항목 | 값 |
|---|---|
| OS | Windows 10 (10.0.26200) |
| Python | 3.14.3 |
| DB | Supabase PostgreSQL (Transaction Pooler) |
| 실행 방식 | `python -m app.pipeline kr-initial` |
| 사전 작업 | 전체 테이블 초기화 후 실행 |

## 단계별 소요시간

### `python -m app.pipeline kr-initial` — 총 11분 48초

| 단계 | 시작 | 종료 | 소요 | 비고 |
|---|---|---|---|---|
| 종목 목록 수집 | 16:39:04 | 16:39:06 | **2초** | KOSPI 896 + KOSDAQ 1,711 = 2,607종목 |
| 섹터 수집 | 16:39:06 | 16:39:46 | **40초** | 89건 업데이트 |
| 일봉 수집 (KOSPI) | 16:39:46 | 16:43:22 | **3분 36초** | 400일 → 263거래일, 230,285건 |
| 일봉 수집 (KOSDAQ) | 16:43:22 | 16:47:48 | **4분 26초** | 400일 → 263거래일, 427,972건 |
| 벤치마크 수집 | 16:47:48 | 16:47:58 | **10초** | KOSPI 6 + KOSDAQ 6 = 12건 |
| 무위험이자율 수집 | 16:47:58 | 16:49:49 | **1분 51초** | 91D 21 + 3Y 70 + 10Y 35 = 126건 |
| 재무제표 수집 | 16:49:49 | 16:50:21 | **32초** | 2,517 corp_codes 동기화, 17,164 stmts |
| 비활성화 + Safety check | 16:50:21 | 16:50:22 | **1초** | 2,459/2,607 active (94.3%) |
| 펀더멘털 계산 | 16:50:22 | 16:50:29 | **7초** | 2,459건 |
| 팩터 모델 | 16:50:29 | 16:50:31 | **2초** | KOSPI 28 + KOSDAQ 28 = 56 팩터 수익률 |
| 지표 계산 | 16:50:31 | 16:50:51 | **20초** | KOSPI 782 + KOSDAQ 1,646 = 2,428종목 |
| 섹터 집계 | 16:50:51 | 16:50:51 | **< 1초** | 42건 |
| **리스크 뱃지 계산** | **16:50:51** | **16:50:51** | **< 1초** | **KOSPI 782 + KOSDAQ 1,646 = 2,428건** |
| 무결성 검사 | 16:50:51 | 16:50:52 | **1초** | PASS |

## 비활성화 현황

| 마켓 | 활성 | 비활성 | 합계 | 활성률 |
|---|---|---|---|---|
| KR_KOSPI | 790 | 106 | 896 | 88.2% |
| KR_KOSDAQ | 1,669 | 42 | 1,711 | 97.5% |
| **합계** | **2,459** | **148** | **2,607** | **94.3%** |

이전 동일 영업일 테스트(KR daily 2/21)와 동일한 활성 수.

## 기존 지표 — 이전 테스트 대비 비교

동일 영업일(2/21)이므로 계산 결과가 일치해야 한다.

| 항목 | daily 테스트 (2/21) | 이번 initial-2 (2/21) | 일치 |
|---|---|---|---|
| 활성 종목 | 2,459 | 2,459 | ✅ |
| 펀더멘털 | 2,459 | 2,459 | ✅ |
| 지표 (KOSPI) | 782/790 | 782/790 | ✅ |
| 지표 (KOSDAQ) | 1,646/1,669 | 1,646/1,669 | ✅ |
| 팩터 수익률 | 56 (2일분) | 56 (1일분 × 2마켓) | ✅ (주1) |
| 섹터 집계 | 84 (2일분) | 42 (1일분) | ✅ (주1) |

**(주1)** factor_returns/sector_aggregates는 날짜별 누적. 이번은 초기실행이므로 1일분만 존재하나, 계산 로직은 동일.

## 리스크 뱃지 검증 (신규)

### 건수 정합성

| 항목 | 파이프라인 로그 | DB 실제 | 일치 |
|---|---|---|---|
| KR_KOSPI | 782 | 782 | ✅ |
| KR_KOSDAQ | 1,646 | 1,646 | ✅ |
| **합계** | **2,428** | **2,428** | ✅ |

뱃지 날짜: 전체 2,428건 모두 `2026-02-21`

### 차원 완전성

| 검증 항목 | 결과 |
|---|---|
| 5개 차원 보유 | 2,428/2,428 (100%) |
| 5개 미만 | 0 |
| data_available=false 포함 | 2건 |

`data_available=false` 2건: KR_KOSPI valuation 차원 — 종목 008700(PER 24,480 / PBR 1,082)과 241560(PER 20,065 / PBR 1,266)의 극단 이상치. 클램핑 후 기본 폴백 점수(50.0) 적용. 설계 문서의 방어 로직대로 정상 동작.

### 종합 뱃지(Composite) 분포

| 마켓 | STABLE | CAUTION | WARNING |
|---|---|---|---|
| KR_KOSPI | 214 (27.4%) | 319 (40.8%) | 249 (31.8%) |
| KR_KOSDAQ | 296 (18.0%) | 656 (39.9%) | 694 (42.2%) |
| **합계** | **510 (21.0%)** | **975 (40.2%)** | **943 (38.8%)** |

KOSDAQ WARNING 비율(42.2%)이 KOSPI(31.8%)보다 높음 — 소형주 비율이 높아 재무 건전성/밸류에이션 리스크가 구조적으로 크기 때문.

### 차원별 티어 분포

| 차원 | 티어 | KOSPI | KOSDAQ |
|---|---|---|---|
| price_heat | STABLE | 668 | 1,477 |
| | CAUTION | 106 | 127 |
| | WARNING | 8 | 42 |
| volatility | STABLE | 732 | 1,562 |
| | CAUTION | 49 | 81 |
| | WARNING | 1 | 3 |
| trend | STABLE | 746 | 1,554 |
| | CAUTION | 36 | 91 |
| | WARNING | 0 | 1 |
| company_health | STABLE | 438 | 736 |
| | CAUTION | 216 | 509 |
| | WARNING | 128 | 401 |
| valuation | STABLE | 392 | 661 |
| | CAUTION | 249 | 593 |
| | WARNING | 141 | 392 |

- **Signal 차원**(price_heat, volatility, trend): STABLE 비율 85~95%. 현재 시장이 기술적으로 안정적인 상태
- **Critical 차원**(company_health, valuation): WARNING 비율 16~24%. 펀더멘털/밸류에이션 리스크가 기술적 리스크보다 높음 — 설계 의도에 부합

### 종합 뱃지 규칙 검증

| 검증 항목 | 결과 | 판정 |
|---|---|---|
| Critical WARNING → summary WARNING | 916건 전부 정확 | ✅ PASS |
| Critical WARNING → NOT WARNING (버그) | 0건 | ✅ PASS |
| Critical WARNING 없는 종목 | 1,512건 | — |

### 차원별 점수 분포

| 마켓 | 전체 평균 | 최솟값 | 최댓값 |
|---|---|---|---|
| KR_KOSPI | 29.7 | 0.0 | 100.0 |
| KR_KOSDAQ | 31.6 | 0.0 | 100.0 |

0~100 범위에 골고루 분포. 평균 ~30점으로 전체적으로 STABLE~CAUTION 경계에 위치.

## 데이터 수집 현황 (DB)

| 테이블 | 건수 |
|---|---|
| stocks | 2,607 |
| daily_prices | 658,257 |
| financial_statements | 17,164 |
| stock_fundamentals | 2,459 |
| stock_indicators | 2,428 |
| factor_exposures | 2,459 |
| factor_returns | 56 |
| sector_aggregates | 42 |
| **risk_badges** | **2,428** |

## 종합 검증 결과

| 검증 항목 | 결과 | 판정 |
|---|---|---|
| 기존 지표 이전 테스트 대비 일치 | 활성/펀더멘털/지표 모두 동일 | PASS |
| 리스크 뱃지 건수 = 지표 건수 | 2,428 = 2,428 | PASS |
| 5개 차원 완전성 | 100% (2,428/2,428) | PASS |
| 종합 뱃지 Critical 규칙 | 916건 전부 정확, 버그 0 | PASS |
| data_available=false 방어 | 2건, 극단 이상치 정상 처리 | PASS |
| 티어 분포 합리성 | KOSDAQ > KOSPI WARNING 비율 | PASS |
| Safety check | 94.3% | PASS |
| 무결성 검사 | no_fs=0, no_price=0 | PASS |

## 발견 사항

| 항목 | 심각도 | 내용 |
|---|---|---|
| 리스크 뱃지 계산 < 1초 | INFO | 2,428종목 뱃지 계산이 1초 미만. 지표 계산(20초) 대비 매우 가벼움 |
| data_available=false 2건 | INFO | PER/PBR 극단 이상치(만 단위). clamp + 폴백 정상 동작 |
| KOSDAQ WARNING 42.2% | INFO | 소형주 구조적 특성. 시스템이 리스크를 올바르게 포착 중 |
| KR 시장 Signal 차원 안정적 | INFO | price_heat/volatility/trend WARNING 합계 55건(2.3%). 현재 시장 상태 반영 |
