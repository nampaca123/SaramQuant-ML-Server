# KR 워크플로우 일간실행 테스트 결과 (2026-02-21)

## 목적

일간(daily) 파이프라인이 기존 데이터를 유지한 채 **누락분만 증분 수집**하고, 계산 결과를 올바르게 갱신하는지 검증한다. 마지막 초기실행(2/17)으로부터 약 4일 경과한 상태에서 실행.

## 실행 환경

| 항목 | 값 |
|---|---|
| OS | Windows 10 (10.0.26200) |
| Python | 3.14.3 |
| DB | Supabase PostgreSQL (Transaction Pooler) |
| 실행 방식 | `python -m app.pipeline kr` |
| 기존 데이터 | 2/17 초기실행분 유지 |

## 단계별 소요시간

### `python -m app.pipeline kr` — 총 2분 2초

| 단계 | 시작 | 종료 | 소요 | 비고 |
|---|---|---|---|---|
| 종목 목록 수집 | 13:14:28 | 13:14:30 | **2초** | KOSPI 896 + KOSDAQ 1,711 = 2,607종목 |
| 섹터 수집 | 13:14:30 | 13:15:33 | **1분 3초** | 업데이트 0건 (변동 없음) |
| 일봉 수집 (KOSPI) | 13:15:35 | 13:15:41 | **6초** | 8일 조회 → 2 거래일, 1,553건 |
| 일봉 수집 (KOSDAQ) | 13:15:44 | 13:15:53 | **9초** | 8일 조회 → 2 거래일, 3,278건 |
| 벤치마크 수집 | 13:15:53 | 13:15:53 | **< 1초** | KOSPI 2 + KOSDAQ 2 = 4건 |
| 무위험이자율 수집 | 13:15:54 | 13:15:56 | **2초** | 91D/3Y/10Y 각 2건 = 6건 |
| 비활성화 | 13:15:56 | 13:15:57 | **1초** | 재활성 148 / 비활성 148 |
| 펀더멘털 계산 | 13:15:57 | 13:16:06 | **9초** | 2,459종목 |
| 팩터 모델 | 13:16:06 | 13:16:08 | **2초** | KOSPI 28 + KOSDAQ 28 = 56 |
| 지표 계산 | 13:16:08 | 13:16:29 | **21초** | 2,428종목 |
| 섹터 집계 | 13:16:29 | 13:16:29 | **< 1초** | 42건 |
| 무결성 검사 | 13:16:29 | 13:16:30 | **1초** | PASS |

**초기실행(11분 44초) 대비 2분 2초** — 82.7% 단축. 일봉 수집이 8분→15초로 감소한 것이 핵심.

## 증분 수집 검증

| 항목 | 초기실행 (2/17) | 일간실행 (2/21) | 검증 |
|---|---|---|---|
| 종목 목록 | 2,607 | 2,607 | 변동 없음 |
| 섹터 | 89건 업데이트 | 0건 업데이트 | 변동 없으면 스킵 |
| 일봉 | 265거래일 전량 | 2거래일 4,831건 | **증분 수집 정상** |
| 벤치마크 | 3,008건 | +4건 | 증분 수집 정상 |
| 무위험이자율 | 19,120건 | +6건 | 증분 수집 정상 |
| 재무제표 | 17,154건 | 수집 안 함 | daily 모드에서는 FS 수집하지 않음 (정상) |

일봉: 4일 공백 중 2거래일만 수집. 주말/공휴일(대통령 선거일 등)을 올바르게 건너뛰었음.

## 재활성화/비활성화 동작

| 동작 | KOSPI | KOSDAQ | 비고 |
|---|---|---|---|
| 재활성화 | 106 | 42 | 이전 초기실행 시 비활성화된 종목 중 조건 충족분 복구 |
| 비활성: no-price | 7 | 30 | 가격 미수신 |
| 비활성: no-sector | 11 | 6 | 섹터 미분류 |
| 비활성: no-FS | 88 | 6 | 재무제표 미보유 |
| **최종 활성** | **790** | **1,669** | **2,459 (94.3%)** |

초기실행(2,459) 대비 동일 활성 수. Safety check 94.3% 통과.

## 계산 결과 갱신 검증

### 펀더멘털

| 항목 | 초기실행 (2/17) | 일간실행 (2/21) | 변화 |
|---|---|---|---|
| 총 건수 | 2,459 | 2,459 | — |
| PER | 89.9% (2,210) | 91.3% (2,246) | +1.4pp |
| EPS | 89.9% | 92.3% | +2.4pp |
| PBR | 99.6% (2,450) | 99.5% (2,447) | -0.1pp |
| ROE | 89.9% (2,210) | 92.1% (2,264) | +2.2pp |
| 부채비율 | 100.0% (2,459) | 99.6% (2,449) | -0.4pp |
| 영업이익률 | 89.8% (2,209) | 89.1% (2,191) | -0.7pp |

- PER +1.4pp: 최신 종가 반영으로 PER 계산 가능 종목 증가 (적자 탈출 종목 or 가격 갱신)
- 부채비율/영업이익률 미소 하락: sanity clamp (bounds check) 신규 도입 영향. 이전에는 극단값도 포함되었으나 이제 clamp 범위 밖 값은 null 처리됨

### Coverage 분포

| Coverage | 초기실행 (2/17) | 일간실행 (2/21) |
|---|---|---|
| FULL | 1,319 | 1,318 |
| LOSS | 880 | 875 |
| PARTIAL | 260 | 266 |

초기실행과 거의 동일. PARTIAL +6건은 일부 종목의 최신 가격 반영으로 coverage 재분류된 것.

### 팩터 노출도

| 항목 | 초기실행 (2/17) | 일간실행 (2/21) | 변화 |
|---|---|---|---|
| 총 건수 | 2,459 | 4,918 | ×2 (주1) |
| size | 100.0% | 100.0% | — |
| value | 99.6% | 99.6% | — |
| momentum | 93.5% | 93.7% | +0.2pp |
| volatility | 99.5% | 99.5% | — |
| quality | 89.9% | 88.6% | -1.3pp |
| leverage | 100.0% | 99.8% | -0.2pp |

**(주1)** factor_exposures에 date 컬럼이 있어 일간실행마다 새 날짜의 행이 추가됨. 2일치 팩터(2/17 + 2/21) = 2,459×2 = 4,918건.

- quality -1.3pp: sanity clamp 도입으로 ROE/영업이익률 극단값이 null 처리 → quality 팩터 입력 감소

### 팩터 수익률

| 마켓 | 초기실행 (2/17) | 일간실행 (2/21) |
|---|---|---|
| KR_KOSPI | 28 | 56 |
| KR_KOSDAQ | 28 | 56 |

일간실행마다 새 날짜의 팩터 수익률이 추가됨. 28×2일 = 56건.

### 지표

| 항목 | 초기실행 (2/17) | 일간실행 (2/21) |
|---|---|---|
| 총 건수 | 2,427 | 2,428 |
| KOSPI 계산 | 782/790 | 782/790 |
| KOSDAQ 계산 | 1,645/1,669 | 1,646/1,669 |

+1종목: 일봉 60일을 새로 충족한 종목.

## 데이터 수집 현황 (일간실행 후 DB 전체)

| 테이블 | 초기실행 후 (2/17) | 일간실행 후 (2/21) | 변화 |
|---|---|---|---|
| stocks | 2,607 | 2,607 | — |
| daily_prices | 663,082 | 667,913 | +4,831 |
| financial_statements | 17,154 | 17,154 | — |
| stock_fundamentals | 2,459 | 2,459 | — (전량 재계산) |
| stock_indicators | 2,427 | 2,428 | +1 |
| factor_exposures | 2,459 | 4,918 | +2,459 (새 날짜분) |
| factor_returns | 56 | 112 | +56 (새 날짜분) |
| sector_aggregates | 42 | 84 | +42 (새 날짜분) |

## 일간실행 모델 검증 결과

| 검증 항목 | 결과 | 판정 |
|---|---|---|
| 일봉 증분 수집 (신규분만) | 2거래일 4,831건만 수집 | PASS |
| 벤치마크/금리 증분 수집 | 각 2건씩만 수집 | PASS |
| 재무제표 수집 안 함 (daily 모드) | 0건 | PASS |
| 펀더멘털 전량 재계산 (최신 가격 반영) | 2,459건 delete+insert | PASS |
| 팩터/지표 전량 재계산 | 정상 | PASS |
| 섹터 집계 갱신 | 42건 upsert | PASS |
| 무결성 검사 통과 | no_fs=0, no_price=0 | PASS |
| 이상 가격 | 0건 | PASS |
| Safety check | 94.3% | PASS |

## 발견 사항

| 항목 | 심각도 | 내용 |
|---|---|---|
| factor_exposures/factor_returns 누적 | INFO | 일간실행마다 새 날짜의 행이 추가됨. 장기 운영 시 관리 정책(TTL/파티션) 필요 |
| indicator 삽입 건수 로그 | LOW | 로그상 "Inserted 28" 표시되나 실제 DB에 2,428건 존재. 기존 미해결 이슈(execute_values rowcount) |
| quality/leverage 미소 하락 | INFO | sanity clamp 신규 도입 영향. 극단값 null 처리에 의한 구조적 변화이며 데이터 악화 아님 |
